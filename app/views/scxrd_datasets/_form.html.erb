<%# app/views/scxrd_datasets/_form.html.erb %>
<div data-controller="scxrd-dataset-uploader">
<%= form_with(model: @well ? [@well, @scxrd_dataset] : @scxrd_dataset, local: true, html: { multipart: true, data: { "scxrd-dataset-uploader-target": "form", persisted: @scxrd_dataset.persisted? } }) do |form| %>
  <% if @scxrd_dataset.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@scxrd_dataset.errors.count, "error") %> prohibited this SCXRD dataset from being saved:</h2>
      <ul>
        <% @scxrd_dataset.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Hidden field for experiment name - will be auto-filled from folder name -->
  <%= form.hidden_field :experiment_name, id: 'scxrd_dataset_experiment_name', data: { "scxrd-dataset-uploader-target": "experimentNameField" } %>



  <!-- Hidden field to store the compressed ZIP file -->
  <input type="file" name="scxrd_dataset[compressed_archive]" id="scxrd_dataset_compressed_archive" data-scxrd-dataset-uploader-target="compressedInput" style="display: none;">

  <!-- Upload type selection -->
  <div class="mb-3">
    <%= form.label :upload_type, "Upload Type", class: 'form-label' %>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="upload_type" id="upload_folder" value="folder" checked data-scxrd-dataset-uploader-target="uploadFolderRadio">
      <label class="form-check-label" for="upload_folder">
        <i class="fas fa-folder me-1"></i>Upload Folder
      </label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="upload_type" id="upload_zip" value="zip" data-scxrd-dataset-uploader-target="uploadZipRadio">
      <label class="form-check-label" for="upload_zip">
        <i class="fas fa-file-archive me-1"></i>Upload Archive File
      </label>
    </div>
  </div>

  <!-- Folder upload section -->
  <div class="mb-3" id="folder-upload-section" data-scxrd-dataset-uploader-target="folderUploadSection">
    <%= form.label :experiment_folder, "Experiment Folder", class: 'form-label' %>
    <input type="file" id="scxrd_dataset_experiment_folder" 
           class="form-control" webkitdirectory directory multiple <%= 'required' unless @scxrd_dataset.persisted? %> data-scxrd-dataset-uploader-target="folderInput">
    <div class="form-text">
      <% if @scxrd_dataset.persisted? %>
        Select a new experiment folder to replace the current dataset, or leave empty to keep existing data.
      <% else %>
        Select the experiment folder from your local machine. Files will be compressed automatically before upload.
      <% end %>
    </div>
    <div id="folder-info" class="mt-2 text-muted small" style="display: none;" data-scxrd-dataset-uploader-target="folderInfo">
      <i class="fas fa-info-circle me-1"></i>Selected: <span id="folder-name" data-scxrd-dataset-uploader-target="folderName"></span> (<span id="file-count" data-scxrd-dataset-uploader-target="fileCount"></span> files)
    </div>
    <div id="compression-progress" class="mt-2" style="display: none;" data-scxrd-dataset-uploader-target="compressionProgress">
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Compressing...</span>
        </div>
        <div class="flex-grow-1">
          <div class="fw-bold">Packaging files...</div>
          <div class="small text-muted mb-1">
            <span id="compression-status" data-scxrd-dataset-uploader-target="compressionStatus">Preparing files</span>
          </div>
          <div class="progress" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                 style="width: 0%" data-scxrd-dataset-uploader-target="progressBar">
              <span id="compression-percent" data-scxrd-dataset-uploader-target="compressionPercent">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ZIP file upload section -->
  <div class="mb-3" id="zip-upload-section" style="display: none;" data-scxrd-dataset-uploader-target="zipUploadSection">
    <%= form.label :zip_file, "Archive File", class: 'form-label' %>
    <input type="file" id="scxrd_dataset_zip_file" 
           class="form-control" accept=".zip,.tar" <%= 'required' unless @scxrd_dataset.persisted? %> data-scxrd-dataset-uploader-target="zipFileInput">
    <div class="form-text">
      <% if @scxrd_dataset.persisted? %>
        Select a new archive file (ZIP or TAR) to replace the current dataset, or leave empty to keep existing data.
      <% else %>
        Select an archive file (ZIP or TAR) containing your SCXRD experiment data.
      <% end %>
    </div>
    <div id="zip-info" class="mt-2 text-muted small" style="display: none;" data-scxrd-dataset-uploader-target="zipInfo">
      <i class="fas fa-info-circle me-1"></i>Selected: <span id="zip-name" data-scxrd-dataset-uploader-target="zipName"></span> (<span id="zip-size" data-scxrd-dataset-uploader-target="zipSize"></span>)
    </div>
  </div>

  <div class="actions">
    <%= form.submit (@scxrd_dataset.persisted? ? "Update SCXRD Dataset" : "Upload SCXRD Dataset"), 
                    class: 'btn btn-primary', 
                    id: 'submit-btn',
                    disabled: true,
                    data: { "scxrd-dataset-uploader-target": "submitBtn" } %>
    <div class="form-text mt-1">
      <small class="text-muted" data-scxrd-dataset-uploader-target="statusText">Select files first to enable upload</small>
    </div>
  </div>
<% end %>
</div>