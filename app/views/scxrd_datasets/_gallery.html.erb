<%# app/views/scxrd_datasets/_gallery.html.erb %>

<%# SCXRD Gallery for well modal %>

<div data-controller="g6-comparison">
  <% if @scxrd_datasets.any? %>
    <!-- Dataset Header (similar to index page) -->
    <% dataset = @scxrd_datasets.first %>
    <div class="card mb-3">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">
              <%= link_to(dataset.experiment_name.presence || "SCXRD Dataset ##{dataset.id}", 
                         well_scxrd_dataset_path(@well, dataset), 
                         class: "text-decoration-none", target: "_blank") %>
            </h5>
            <div class="text-muted small">
              <% if @well.present? %>
                <strong>Well:</strong> 
                <%= link_to "#{@well.plate.barcode}-#{@well.well_label}", 
                           @well.plate, 
                           class: "text-decoration-none", target: "_blank" %>
                <% if dataset.real_world_x_mm.present? && dataset.real_world_y_mm.present? && dataset.real_world_z_mm.present? %>
                  <span class="text-info ms-2">
                    (x=<%= number_with_precision(dataset.real_world_x_mm, precision: 2) %>mm, 
                     y=<%= number_with_precision(dataset.real_world_y_mm, precision: 2) %>mm, 
                     z=<%= number_with_precision(dataset.real_world_z_mm, precision: 2) %>mm)
                  </span>
                <% end %>
                | 
              <% end %>
              <strong>Measured:</strong> <%= (dataset.measured_at || dataset.created_at).strftime('%b %d, %Y at %H:%M') %>
              <% if dataset.has_primitive_cell? %>
                | <strong>Unit Cell:</strong> <%= format_unit_cell(dataset) %>
              <% end %>
            </div>
          </div>
          <div class="text-end">
            <div class="d-flex align-items-center gap-2">
              <% if dataset.has_primitive_cell? %>
                <%= g6_comparison_button(dataset, well_context: true) %>
              <% end %>
              <div class="btn-group btn-group-sm">
                <%= link_to well_scxrd_dataset_path(@well, dataset), 
                           class: "btn btn-outline-primary btn-sm", target: "_blank" do %>
                  <i class="bi bi-eye"></i> Details
                <% end %>
                <% if dataset.archive.attached? %>
                  <%= link_to download_scxrd_dataset_path(dataset), 
                             class: "btn btn-outline-success btn-sm" do %>
                    <i class="bi bi-download"></i> Archive
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Use the reusable dataset viewer for the first dataset -->
    <%= render 'scxrd_datasets/dataset_viewer', dataset: @scxrd_datasets.first, well: @well, index: 0 %>

    <!-- Dataset Navigator -->
    <% if @scxrd_datasets.count > 0 %>
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold">SCXRD Datasets (<%= @scxrd_datasets.count %>)</span>
          <a href="<%= new_well_scxrd_dataset_path(@well) %>" class="btn btn-sm btn-primary" target="_blank">
            <i class="fas fa-plus me-1"></i>Add Dataset
          </a>
        </div>
        
        <div class="card-body p-2">
          <div class="row g-2">
            <% @scxrd_datasets.each_with_index do |dataset, index| %>
              <div class="col-6 col-md-4 col-lg-3">
                <div class="card scxrd-thumbnail <%= 'border-primary' if index == 0 %>" 
                     data-dataset-id="<%= dataset.id %>"
                     style="cursor: pointer; transition: all 0.2s;"
                     onclick="showScxrdDatasetInMain('<%= dataset.id %>', '<%= j(dataset.experiment_name) %>', '<%= well_scxrd_dataset_path(@well, dataset) %>', '<%= @well.id %>', 'scxrd-<%= @scxrd_datasets.first.id %>-0')">
                  <div class="card-body p-2 text-center">
                    <div class="mb-2">
                      <% if dataset.has_first_image? %>
                        <i class="fas fa-camera fa-2x text-primary"></i>
                      <% else %>
                        <i class="fas fa-camera fa-2x text-muted"></i>
                      <% end %>
                    </div>
                    <div class="small fw-bold text-truncate" title="<%= dataset.experiment_name %>">
                      <%= dataset.experiment_name %>
                    </div>
                    <div class="text-muted" style="font-size: 0.75rem;">
                      <%= dataset.measured_at&.strftime("%m/%d/%y") || "No date" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- G6 Unit Cell Comparison Modal for Well Modal -->
    <div class="modal fade" id="wellG6ComparisonModal" tabindex="-1" aria-labelledby="wellG6ComparisonModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="wellG6ComparisonModalLabel">
              <i class="bi bi-box-seam me-2"></i>Unit Cell Analysis
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- G6 Tolerance Control -->
            <div class="mb-3">
              <div class="row align-items-center">
                <div class="col-auto">
                  <label for="g6Tolerance" class="form-label me-2">G6 Tolerance:</label>
                  <input type="number" id="g6Tolerance" class="form-control d-inline-block" 
                         style="width: 80px;" value="10.0" step="0.1" min="0.1"
                         data-g6-comparison-target="toleranceInput">
                  <button type="button" class="btn btn-outline-secondary btn-sm ms-2" 
                          data-action="click->g6-comparison#updateG6Comparison">Update</button>
                </div>
              </div>
            </div>

            <!-- Local Database Comparison -->
            <div data-g6-comparison-target="g6Content">
              <div class="text-center py-4">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Searching for similar unit cells...</p>
              </div>
            </div>

            <!-- CSD Search Results -->
            <div class="mt-4">
              <h6 class="border-bottom pb-2">
                <i class="bi bi-globe me-2"></i>Cambridge Structural Database Results
              </h6>
              <div data-g6-comparison-target="csdContent">
                <div class="text-center py-3">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2 mb-0">Searching CSD...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  <% else %>
    <div class="alert alert-info text-center">
      <h6>No SCXRD Datasets</h6>
      <p>No single crystal X-ray diffraction datasets have been uploaded for this well yet.</p>
      <a href="<%= new_well_scxrd_dataset_path(@well) %>" class="btn btn-primary">Add First SCXRD Dataset</a>
    </div>
  <% end %>
</div>