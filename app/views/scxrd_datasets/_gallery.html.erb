<%# app/views/scxrd_datasets/_gallery.html.erb %>

<%# SCXRD Gallery for well modal %>

  <% if @scxrd_datasets.any? %>
    <!-- Dataset Header (similar to index page) -->
    <% dataset = @scxrd_datasets.first %>
    <div class="card mb-3">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">
              <%= link_to(dataset.experiment_name.presence || "SCXRD Dataset ##{dataset.id}", 
                         well_scxrd_dataset_path(@well, dataset), 
                         class: "text-decoration-none", target: "_blank") %>
            </h5>
            <div class="text-muted small">
              <% if @well.present? %>
                <strong>Well:</strong> 
                <%= link_to "#{@well.plate.barcode}-#{@well.well_label}", 
                           @well.plate, 
                           class: "text-decoration-none", target: "_blank" %>
                <% if dataset.real_world_x_mm.present? && dataset.real_world_y_mm.present? && dataset.real_world_z_mm.present? %>
                  <span class="text-info ms-2">
                    (x=<%= number_with_precision(dataset.real_world_x_mm, precision: 2) %>mm, 
                     y=<%= number_with_precision(dataset.real_world_y_mm, precision: 2) %>mm, 
                     z=<%= number_with_precision(dataset.real_world_z_mm, precision: 2) %>mm)
                  </span>
                <% end %>
                | 
              <% end %>
              <strong>Measured:</strong> <%= (dataset.measured_at || dataset.created_at).strftime('%b %d, %Y at %H:%M') %>
              <% if dataset.has_primitive_cell? %>
                | <strong>Unit Cell:</strong> 
                <%= format_unit_cell(dataset) %>
              <% end %>
            </div>
          </div>
          <div class="text-end">
            <div class="d-flex align-items-center gap-2">
              <% if dataset.has_primitive_cell? %>
                <%= g6_comparison_button(dataset) %>
              <% end %>
              <div class="btn-group btn-group-sm">
                <%= link_to well_scxrd_dataset_path(@well, dataset), 
                           class: "btn btn-outline-primary btn-sm", target: "_blank" do %>
                  <i class="bi bi-eye"></i> Details
                <% end %>
                <% if dataset.archive.attached? %>
                  <%= link_to download_scxrd_dataset_path(dataset), 
                             class: "btn btn-outline-success btn-sm" do %>
                    <i class="bi bi-download"></i> Archive
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Use the reusable dataset viewer for the first dataset -->
    <%= render 'scxrd_datasets/dataset_viewer', dataset: @scxrd_datasets.first, well: @well, index: 0 %>

    <!-- Dataset Navigator -->
    <% if @scxrd_datasets.count > 0 %>
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold">SCXRD Datasets (<%= @scxrd_datasets.count %>)</span>
          <a href="<%= new_well_scxrd_dataset_path(@well) %>" class="btn btn-sm btn-primary" target="_blank">
            <i class="fas fa-plus me-1"></i>Add Dataset
          </a>
        </div>
        
        <div class="card-body p-2">
          <div class="row g-2">
            <% @scxrd_datasets.each_with_index do |dataset, index| %>
              <div class="col-6 col-md-4 col-lg-3">
                <div class="card scxrd-thumbnail <%= 'border-primary' if index == 0 %>" 
                     data-dataset-id="<%= dataset.id %>"
                     style="cursor: pointer; transition: all 0.2s;"
                     onclick="showScxrdDatasetInMain('<%= dataset.id %>', '<%= j(dataset.experiment_name) %>', '<%= well_scxrd_dataset_path(@well, dataset) %>', '<%= @well.id %>', 'scxrd-<%= @scxrd_datasets.first.id %>-0')">
                  <div class="card-body p-2 text-center">
                    <div class="mb-2">
                      <% if dataset.has_first_image? %>
                        <i class="fas fa-camera fa-2x text-primary"></i>
                      <% else %>
                        <i class="fas fa-camera fa-2x text-muted"></i>
                      <% end %>
                    </div>
                    <div class="small fw-bold text-truncate" title="<%= dataset.experiment_name %>">
                      <%= dataset.experiment_name %>
                    </div>
                    <div class="text-muted" style="font-size: 0.75rem;">
                      <%= dataset.measured_at&.strftime("%m/%d/%y") || "No date" %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- G6 Comparison Modal -->
    <div class="modal fade" id="g6ComparisonModal" tabindex="-1" aria-labelledby="g6ComparisonModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="g6ComparisonModalLabel">
              <i class="bi bi-box-seam me-2"></i>Unit Cell Comparison (G6 Distance)
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="g6ComparisonContent">
            <div class="text-center py-4">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Searching for similar unit cells...</p>
            </div>
          </div>
          <div class="modal-footer">
            <div class="me-auto">
              <label for="g6Tolerance" class="form-label me-2">Tolerance:</label>
              <input type="number" id="g6Tolerance" class="form-control d-inline-block" 
                     style="width: 80px;" value="10.0" step="0.1" min="0.1">
              <button type="button" class="btn btn-outline-secondary btn-sm ms-2" 
                      onclick="updateG6Comparison()">Update</button>
            </div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // G6 comparison functionality (same as index page)
      window.currentDatasetId = null;

      window.loadG6Comparison = function(datasetId) {
        window.currentDatasetId = datasetId;
        const tolerance = document.getElementById('g6Tolerance').value;
        
        // Show loading state
        document.getElementById('g6ComparisonContent').innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Searching for similar unit cells...</p>
          </div>
        `;
        
        // Fetch comparison data
        fetch(\`/scxrd_datasets/\${datasetId}/g6_similar?tolerance=\${tolerance}\`)
          .then(response => response.json())
          .then(data => {
            displayG6Results(data);
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('g6ComparisonContent').innerHTML = \`
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Error loading comparison data: \${error.message}
              </div>
            \`;
          });
      }

      window.updateG6Comparison = function() {
        if (window.currentDatasetId) {
          window.loadG6Comparison(window.currentDatasetId);
        }
      }

      window.displayG6Results = function(data) {
        const content = document.getElementById('g6ComparisonContent');
        
        if (!data.success) {
          content.innerHTML = \`
            <div class="alert alert-warning">
              <i class="bi bi-info-circle me-2"></i>
              \${data.error}
            </div>
          \`;
          return;
        }

        if (data.count === 0) {
          content.innerHTML = \`
            <div class="alert alert-info">
              <i class="bi bi-search me-2"></i>
              No similar unit cells found within G6 distance of \${data.tolerance}.
              <hr>
              <small class="text-muted">
                <strong>Current dataset:</strong> \${data.current_dataset.experiment_name}<br>
                <strong>G6 vector:</strong> [\${data.current_dataset.g6_vector.map(v => v.toFixed(2)).join(', ')}]
              </small>
            </div>
          \`;
          return;
        }

        let html = \`
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            Found <strong>\${data.count}</strong> dataset(s) with similar unit cells (G6 distance ≤ \${data.tolerance})
          </div>
          
          <div class="mb-3">
            <small class="text-muted">
              <strong>Reference dataset:</strong> \${data.current_dataset.experiment_name}<br>
              <strong>G6 vector:</strong> [\${data.current_dataset.g6_vector.map(v => v.toFixed(2)).join(', ')}]
            </small>
          </div>

          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Dataset</th>
                  <th>Unit Cell</th>
                  <th>G6 Distance</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
        \`;

        data.datasets.forEach(dataset => {
          const unitCellText = dataset.unit_cell ? 
            \`\${dataset.unit_cell.bravais} a=\${dataset.unit_cell.a}Å b=\${dataset.unit_cell.b}Å c=\${dataset.unit_cell.c}Å α=\${dataset.unit_cell.alpha}° β=\${dataset.unit_cell.beta}° γ=\${dataset.unit_cell.gamma}°\` : 
            'No unit cell';
          
          const locationText = dataset.well ? 
            \`\${dataset.well.plate_barcode}-\${dataset.well.label}\` : 
            'Standalone';

          html += \`
            <tr>
              <td>
                <strong>\${dataset.experiment_name}</strong><br>
                <small class="text-muted">\${dataset.measured_at}</small>
              </td>
              <td><small>\${unitCellText}</small></td>
              <td><span class="badge bg-info">\${dataset.g6_distance}</span></td>
              <td><small>\${locationText}</small></td>
              <td>
                <a href="/scxrd_datasets/\${dataset.id}" class="btn btn-outline-primary btn-sm" target="_blank">
                  <i class="bi bi-eye"></i> View
                </a>
              </td>
            </tr>
          \`;
        });

        html += \`
              </tbody>
            </table>
          </div>
        \`;

        content.innerHTML = html;
      }
    </script>

<% else %>
  <div class="alert alert-info text-center">
    <h6>No SCXRD Datasets</h6>
    <p>No single crystal X-ray diffraction datasets have been uploaded for this well yet.</p>
    <a href="<%= new_well_scxrd_dataset_path(@well) %>" class="btn btn-primary">Add First SCXRD Dataset</a>
  </div>
<% end %>