<%= form_with(model: location, local: true) do |form| %>
  <% if location.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(location.errors.count, "error") %> prohibited this location from being saved:</h4>
      <ul>
        <% location.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% 
    # Determine initial state based on location data
    # For existing records, use their data to determine type
    # For new records, default to special location
    is_carousel_type = location.carousel_position.present? && location.hotel_position.present?
    is_special_type = location.name.present? || (location.new_record? && !is_carousel_type)
  %>

  <div class="mb-4">
    <label class="form-label fw-bold">Location Type</label>
    
    <!-- Radio buttons to choose location type -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="location_type" id="carousel_location" value="carousel" 
                     <%= is_carousel_type ? 'checked' : '' %>>
              <label class="form-check-label fw-semibold" for="carousel_location">
                <i class="bi bi-grid-3x3-gap me-2"></i>Carousel/Hotel Position
              </label>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="location_type" id="special_location" value="special" 
                     <%= is_special_type ? 'checked' : '' %>>
              <label class="form-check-label fw-semibold" for="special_location">
                <i class="bi bi-geo-alt me-2"></i>Special Location
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Carousel position fields -->
    <div id="carousel_fields" class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <%= form.label :carousel_position, "Carousel Position", class: "form-label" %>
            <%= form.number_field :carousel_position, class: "form-control", min: 1, 
                                  value: location.carousel_position || 1 %>
            <div class="form-text">Select carousel position</div>
          </div>
          <div class="col-md-6">
            <%= form.label :hotel_position, "Hotel Position", class: "form-label" %>
            <%= form.number_field :hotel_position, class: "form-control", min: 1, 
                                  value: location.hotel_position || 1 %>
            <div class="form-text">Select hotel position</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Special location fields -->
    <div id="special_fields" class="card">
      <div class="card-body">
        <%= form.label :name, "Name", class: "form-label" %>
        <%= form.text_field :name, class: "form-control", 
                           placeholder: "Enter location name (e.g., 'imager', 'storage')" %>
        <div class="form-text">Enter a descriptive name for this special location</div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end">
    <%= form.submit class: "btn btn-primary" %>
  </div>
<% end %>

<script>
// Use Turbo-compatible event listeners for both initial load and navigation
function initializeLocationForm() {
  const carouselRadio = document.getElementById('carousel_location');
  const specialRadio = document.getElementById('special_location');
  const carouselFields = document.getElementById('carousel_fields');
  const specialFields = document.getElementById('special_fields');

  // Return early if elements don't exist (in case script runs on wrong page)
  if (!carouselRadio || !specialRadio || !carouselFields || !specialFields) {
    return;
  }

  function toggleFields() {
    if (carouselRadio.checked) {
      carouselFields.style.display = 'block';
      specialFields.style.display = 'none';
      
      // Clear special location fields when switching to carousel
      const nameField = document.querySelector('input[name="location[name]"]');
      if (nameField) nameField.value = '';
    } else {
      // Default to special location (either explicitly checked or as fallback)
      carouselFields.style.display = 'none';
      specialFields.style.display = 'block';
      
      // If switching from carousel, clear carousel fields
      if (!specialRadio.checked) {
        specialRadio.checked = true;
      }
      
      const carouselPosField = document.querySelector('input[name="location[carousel_position]"]');
      const hotelPosField = document.querySelector('input[name="location[hotel_position]"]');
      if (carouselPosField && carouselRadio.checked === false) carouselPosField.value = '';
      if (hotelPosField && carouselRadio.checked === false) hotelPosField.value = '';
    }
  }

  // Set initial state
  toggleFields();

  // Add event listeners
  carouselRadio.addEventListener('change', toggleFields);
  specialRadio.addEventListener('change', toggleFields);
}

// Listen for both DOMContentLoaded (initial page load) and turbo:load (Turbo navigation)
document.addEventListener('DOMContentLoaded', initializeLocationForm);
document.addEventListener('turbo:load', initializeLocationForm);</script>
