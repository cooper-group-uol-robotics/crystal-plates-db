<% content_for :title, "PXRD Pattern Details for Well #{@well.well_label_with_subwell}" %>

<% 
  # Get parsed data for metadata display
  parsed_data = @pxrd_pattern.parse_diffraction_data
  data_points = parsed_data[:two_theta]&.size || 0
  format = parsed_data[:format]&.upcase
  wavelength = parsed_data[:wavelength]
  two_theta_range = if parsed_data[:two_theta]&.any?
    "#{parsed_data[:two_theta].first.round(2)}° - #{parsed_data[:two_theta].last.round(2)}°"
  else
    "N/A"
  end
%>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card mt-4">
        <div class="card-header">
          <h4 class="mb-0">PXRD Pattern Details for Well <%= @well.well_label_with_subwell %></h4>
          <small class="text-muted">Plate: <%= @well.plate.barcode %></small>
        </div>
        <div class="card-body">
          <dl class="row">
            <dt class="col-sm-3">Title</dt>
            <dd class="col-sm-9"><%= @pxrd_pattern.title %></dd>

            <dt class="col-sm-3">Measured</dt>
            <dd class="col-sm-9">
              <%= (@pxrd_pattern.measured_at || @pxrd_pattern.created_at).strftime('%Y-%m-%d %H:%M') %>
              <% if @pxrd_pattern.measured_at %>
                <small class="text-muted">(from XRDML file)</small>
              <% else %>
                <small class="text-muted">(upload time)</small>
              <% end %>
            </dd>

            <dt class="col-sm-3">Uploaded</dt>
            <dd class="col-sm-9"><%= @pxrd_pattern.created_at.strftime('%Y-%m-%d %H:%M') %></dd>

            <dt class="col-sm-3">Data File</dt>
            <dd class="col-sm-9">
              <% if @pxrd_pattern.pxrd_data_file.attached? %>
                <%= link_to @pxrd_pattern.pxrd_data_file.filename, url_for(@pxrd_pattern.pxrd_data_file) %>
              <% else %>
                <span class="text-muted">No diffraction data file uploaded.</span>
              <% end %>
            </dd>

            <dt class="col-sm-3">Format</dt>
            <dd class="col-sm-9">
              <span class="badge bg-primary"><%= format || 'Unknown' %></span>
            </dd>

            <dt class="col-sm-3">Data Points</dt>
            <dd class="col-sm-9"><%= number_with_delimiter(data_points) %></dd>

            <dt class="col-sm-3">2θ Range</dt>
            <dd class="col-sm-9"><%= two_theta_range %></dd>

            <% if wavelength %>
              <dt class="col-sm-3">Wavelength</dt>
              <dd class="col-sm-9"><%= wavelength %> Å</dd>
            <% end %>
          </dl>

          <%= render partial: 'pxrd_patterns/plot', locals: { pxrd_pattern: @pxrd_pattern, include_chartjs: true } %>

          <div class="mt-3">
            <%= link_to 'Edit', edit_well_pxrd_pattern_path(@well, @pxrd_pattern), class: 'btn btn-primary' %>
            <%= link_to 'Delete', well_pxrd_pattern_path(@well, @pxrd_pattern), method: :delete, 
                        class: 'btn btn-danger ms-2', 
                        confirm: 'Are you sure you want to delete this PXRD pattern? This action cannot be undone.',
                        title: 'Delete PXRD Pattern' %>
            <%= link_to 'Back to Plate', @well.plate, class: 'btn btn-secondary ms-2' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
