<%# app/views/pxrd_patterns/_plot.html.erb %>
<% require 'nokogiri' %>
<% if pxrd_pattern.xrdml_file.attached? %>
  <% xrdml_xml = Nokogiri::XML(pxrd_pattern.xrdml_file.download) %>
  <% start_2theta = xrdml_xml.at_xpath('//xmlns:dataPoints/xmlns:positions[@axis="2Theta"]//xmlns:startPosition', 'xmlns' => 'http://www.xrdml.com/XRDMeasurement/1.5').text.to_f rescue nil %>
  <% end_2theta = xrdml_xml.at_xpath('//xmlns:dataPoints/xmlns:positions[@axis="2Theta"]//xmlns:endPosition', 'xmlns' => 'http://www.xrdml.com/XRDMeasurement/1.5').text.to_f rescue nil %>
  <% intensities_str = xrdml_xml.at_xpath('//xmlns:dataPoints/xmlns:intensities', 'xmlns' => 'http://www.xrdml.com/XRDMeasurement/1.5').text rescue nil %>
  <% if start_2theta && end_2theta && intensities_str %>
    <% intensities = intensities_str.split.map(&:to_f) %>
    <% n_points = intensities.size %>
    <% step = (end_2theta - start_2theta) / (n_points - 1) %>
    <% two_theta = Array.new(n_points) { |i| (start_2theta + i * step).round(2) } %>
    <div class="my-2" style="position: relative; height: 400px;">
      <canvas id="pxrd-main-plot"></canvas>
    </div>
    <script>
      (function() {
        function renderPxrdChart() {
          const ctx = document.getElementById('pxrd-main-plot');
          if (!ctx || !window.Chart) return;
          
          // Destroy existing chart if it exists
          if (window.currentPxrdChart) {
            window.currentPxrdChart.destroy();
          }
          
          const scatterData = <%= raw two_theta.each_with_index.map { |t, i| { x: t, y: intensities[i] } }.to_json %>;
          window.currentPxrdChart = new window.Chart(ctx.getContext('2d'), {
            type: 'scatter',
            data: {
              datasets: [{
                label: '<%= pxrd_pattern.title %>',
                data: scatterData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                showLine: true,
                pointRadius: 0,
                borderWidth: 2,
                fill: false,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: false },
                zoom: {
                  pan: { enabled: true, mode: 'xy', modifierKey: 'ctrl' },
                  zoom: { drag: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }
                }
              },
              scales: {
                x: {
                  type: 'linear',
                  title: { display: true, text: '2Î¸ (degrees)' },
                  ticks: {
                    maxTicksLimit: 10,
                    callback: function(value) { return parseFloat(value).toFixed(2); }
                  }
                },
                y: {
                  title: { display: true, text: 'Intensity (counts)' }
                }
              }
            }
          });
        }
        
        // Render immediately since Chart.js should be available
        renderPxrdChart();
      })();
    </script>
  <% else %>
    <div class="alert alert-warning">Could not parse XRMDL data for this pattern.</div>
  <% end %>
<% else %>
  <div class="alert alert-warning">No XRMDL file attached.</div>
<% end %>
