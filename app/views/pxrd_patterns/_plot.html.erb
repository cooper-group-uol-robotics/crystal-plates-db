<%# app/views/pxrd_patterns/_plot.html.erb %>

<% if local_assigns[:include_chartjs] %>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<% end %>

<% if pxrd_pattern.pxrd_data_file.attached? %>
  <% 
    # Parse diffraction data using the model method
    data = pxrd_pattern.parse_diffraction_data
    two_theta = data[:two_theta]
    intensities = data[:intensities]
    file_format = data[:format]
    
    parsing_success = two_theta&.any? && intensities&.any?
  %>
  
  <% if parsing_success %>
    <div class="py-4" style="position: relative; height: 400px;">
      <canvas id="pxrd-main-plot"></canvas>
    </div>
    <script>
      (function() {
        function renderPxrdChart() {
          const ctx = document.getElementById('pxrd-main-plot');
          if (!ctx || !window.Chart) return;
          
          // Destroy existing chart if it exists
          if (window.currentPxrdChart) {
            window.currentPxrdChart.destroy();
          }
          
          const scatterData = <%= raw two_theta.each_with_index.map { |t, i| { x: t, y: intensities[i] } }.to_json %>;
          window.currentPxrdChart = new window.Chart(ctx.getContext('2d'), {
            type: 'scatter',
            data: {
              datasets: [{
                label: '<%= pxrd_pattern.title %> (<%= file_format&.upcase %>)',
                data: scatterData,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                showLine: true,
                pointRadius: 0,
                borderWidth: 2,
                fill: false,
                tension: 0.1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: false },
                zoom: {
                  pan: { enabled: true, mode: 'xy', modifierKey: 'ctrl' },
                  zoom: { drag: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }
                }
              },
              scales: {
                x: {
                  type: 'linear',
                  title: { display: true, text: '2Î¸ (degrees)' },
                  ticks: {
                    maxTicksLimit: 10,
                    callback: function(value) { return parseFloat(value).toFixed(2); }
                  }
                },
                y: {
                  title: { display: true, text: 'Intensity (counts)' },
                  beginAtZero: true
                }
              }
            }
          });
        }
        
        // Render immediately since Chart.js should be available
        renderPxrdChart();
      })();
    </script>
  <% else %>
    <div class="alert alert-warning">
      <h6>Could not parse diffraction data for this pattern</h6>
    </div>
  <% end %>
<% else %>
  <div class="alert alert-warning">No diffraction data file attached.</div>
<% end %>
