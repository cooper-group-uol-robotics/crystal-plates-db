<% content_for :title, "Image Details" %>

<style>
  .point-marker {
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .point-marker:hover {
    transform: scale(1.2);
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
  }
  
  .point-crystal { 
    background-color: #007bff !important; 
  }
  
  .point-particle { 
    background-color: #6c757d !important; 
  }
  
  .point-droplet { 
    background-color: #17a2b8 !important; 
  }
  
  .point-other { 
    background-color: #ffc107 !important; 
  }
  
  #image-container {
    position: relative;
    display: inline-block;
  }
  
  [data-interactive-image-target="overlay"] {
    pointer-events: none;
  }
  
  [data-interactive-image-target="image"] {
    user-select: none;
  }
  
  .btn-xs {
    padding: 0.125rem 0.25rem;
    font-size: 0.75rem;
    border-radius: 0.125rem;
  }
  
  .bi-arrow-clockwise {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>

<div class="container">
<%# Navigation logic for keyboard shortcuts %>
<% wells = @well.plate.wells.includes(:images).order(:well_row, :well_column, :subwell) %>
<% well_index = wells.index(@well) %>

<%# Find previous/next wells that have images %>
<% prev_well = nil %>
<% if well_index && well_index > 0 %>
  <% (well_index - 1).downto(0) do |i| %>
    <% if wells[i].images.any? %>
      <% prev_well = wells[i] %>
      <% break %>
    <% end %>
  <% end %>
<% end %>

<% next_well = nil %>
<% if well_index && well_index < wells.size - 1 %>
  <% ((well_index + 1)...wells.size).each do |i| %>
    <% if wells[i].images.any? %>
      <% next_well = wells[i] %>
      <% break %>
    <% end %>
  <% end %>
<% end %>

<% images = @well.images.order(captured_at: :asc, created_at: :asc) %>
<% image_index = images.index(@image) %>
<% prev_image = images[image_index - 1] if image_index && image_index > 0 %>
<% next_image = images[image_index + 1] if image_index && image_index < images.size - 1 %>

<%# Debug output %>
<!-- Debug: Total wells: <%= wells.size %>, Current well index: <%= well_index %> -->
<!-- Debug: Prev well: <%= prev_well ? prev_well.well_label : '' %>, Next well: <%= next_well ? next_well.well_label : '' %> -->
<!-- Debug: Total images: <%= images.size %>, Current image index: <%= image_index %> -->
<!-- Debug: Prev image: <%= prev_image ? prev_image.id : '' %>, Next image: <%= next_image ? next_image.id : '' %> -->

<%# URLs for navigation %>
<% prevWellUrl = prev_well ? well_image_path(prev_well, prev_well.images.first) : nil %>
<% nextWellUrl = next_well ? well_image_path(next_well, next_well.images.first) : nil %>
<% prevImageUrl = prev_image ? well_image_path(@well, prev_image) : nil %>
<% nextImageUrl = next_image ? well_image_path(@well, next_image) : nil %>

  <div class="row">
    <div class="col-md-8">
      <div class="card" data-controller="interactive-image"
           data-interactive-image-image-id-value="<%= @image.id %>"
           data-interactive-image-well-id-value="<%= @well.id %>"
           data-interactive-image-original-width-value="<%= @image.pixel_width %>"
           data-interactive-image-original-height-value="<%= @image.pixel_height %>"
           data-interactive-image-prev-well-url-value="<%= prevWellUrl %>"
           data-interactive-image-next-well-url-value="<%= nextWellUrl %>"
           data-interactive-image-prev-image-url-value="<%= prevImageUrl %>"
           data-interactive-image-next-image-url-value="<%= nextImageUrl %>">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0">Image for Well <%= @well.well_label_with_subwell %></h4>
          <div>
            <%= link_to 'Edit', edit_well_image_path(@well, @image), class: 'btn btn-outline-primary btn-sm me-2' %>
            <%= button_to 'Delete', well_image_path(@well, @image), method: :delete, 
                          class: 'btn btn-outline-danger btn-sm',
                          form: { style: "display: inline-block;" },
                          data: { confirm: "Are you sure you want to delete this image?" } %>
          </div>
        </div>
        <div class="card-body">
          <% if @image.file.attached? %>
            <div class="mb-4">
              <!-- Interactive Image Container -->
              <div id="image-container" class="position-relative d-inline-block">
                <% begin %>
                  <%= image_tag @image.file.variant(resize_to_limit: [800, 600]), 
                      class: "img-fluid img-thumbnail",
                      style: "cursor: crosshair; user-select: none;",
                      data: { 
                        "interactive-image-target": "image",
                        "action": "click->interactive-image#handleImageClick"
                      } %>
                  <!-- Points of Interest will be dynamically added here -->
                  <div class="position-absolute top-0 start-0 w-100 h-100 pointer-events-none" 
                       data-interactive-image-target="overlay"></div>
                <% rescue => e %>
                  <div class="alert alert-warning">
                    <p><strong>Could not display image preview:</strong> <%= e.message %></p>
                    <p>You can still <%= link_to 'download the original file', @image.file, target: '_blank' %></p>
                  </div>
                <% end %>
              </div>
              
              <!-- Point Selection Controls -->
              <div class="mt-3">
                <div class="btn-group me-3" role="group" aria-label="Point Type">
                  <input type="radio" class="btn-check" name="pointType" id="crystal" value="crystal" checked>
                  <label class="btn btn-outline-primary btn-sm" for="crystal">Crystal</label>
                  
                  <input type="radio" class="btn-check" name="pointType" id="particle" value="particle">
                  <label class="btn btn-outline-secondary btn-sm" for="particle">Particle</label>
                  
                  <input type="radio" class="btn-check" name="pointType" id="droplet" value="droplet">
                  <label class="btn btn-outline-info btn-sm" for="droplet">Droplet</label>
                  
                  <input type="radio" class="btn-check" name="pointType" id="other" value="other">
                  <label class="btn btn-outline-warning btn-sm" for="other">Other</label>
                </div>
                
                <button class="btn btn-outline-danger btn-sm me-2"
                        data-interactive-image-target="clearPointsBtn"
                        data-action="click->interactive-image#clearAllPoints">Clear All Points</button>
                <button class="btn btn-outline-dark btn-sm me-2"
                        data-interactive-image-target="togglePointsBtn"
                        data-action="click->interactive-image#togglePointsVisibility">Hide Points</button>
                <button class="btn btn-outline-success btn-sm"
                        data-interactive-image-target="autoSegmentBtn"
                        data-action="click->interactive-image#autoSegment">
                  <i class="bi bi-magic"></i> Auto Segment
                </button>
              </div>
              
              <!-- Points List -->
              <div class="mt-3" style="display: none;" data-interactive-image-target="pointsList">
                <h6>Points of Interest (<span data-interactive-image-target="pointsCount">0</span>)</h6>
                <div data-interactive-image-target="pointsTableContainer">
                  <!-- Points table will be populated by JavaScript -->
                </div>
              </div>
            </div>
          <% end %>
          
          <div class="row">
            <div class="col-md-6">
              <h5>Image Properties</h5>
              <table class="table table-sm">
                <tr>
                  <td><strong>Dimensions:</strong></td>
                  <td><%= @image.pixel_width %>×<%= @image.pixel_height %> pixels</td>
                </tr>
                <tr>
                  <td><strong>Physical Size:</strong></td>
                  <td>
                    <% if @image.physical_width_mm && @image.physical_height_mm %>
                      <%= sprintf("%.3f", @image.physical_width_mm) %>×<%= sprintf("%.3f", @image.physical_height_mm) %> mm
                    <% else %>
                      Not calibrated
                    <% end %>
                  </td>
                </tr>
                <tr>
                  <td><strong>Pixel Size:</strong></td>
                  <td>
                    <% if @image.pixel_size_x_mm && @image.pixel_size_y_mm %>
                      <%= sprintf("%.6f", @image.pixel_size_x_mm) %>×<%= sprintf("%.6f", @image.pixel_size_y_mm) %> mm/pixel
                    <% else %>
                      Not calibrated
                    <% end %>
                  </td>
                </tr>
                <% if @image.captured_at %>
                <tr>
                  <td><strong>Captured:</strong></td>
                  <td><%= @image.captured_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
                </tr>
                <% end %>
              </table>
            </div>
            
            <div class="col-md-6">
              <h5>Spatial Coordinates</h5>
              <table class="table table-sm">
                <tr>
                  <td><strong>Reference Point:</strong></td>
                  <td>
                    <% if @image.reference_x_mm && @image.reference_y_mm && @image.reference_z_mm %>
                      (<%= sprintf("%.3f", @image.reference_x_mm) %>, <%= sprintf("%.3f", @image.reference_y_mm) %>, <%= sprintf("%.3f", @image.reference_z_mm) %>)
                    <% else %>
                      Not set
                    <% end %>
                  </td>
                </tr>
                <tr>
                  <td><strong>Bounding Box:</strong></td>
                  <td>
                    <% bbox = @image.bounding_box %>
                    <% if bbox[:min_x] && bbox[:min_y] && bbox[:max_x] && bbox[:max_y] %>
                      X: <%= sprintf("%.3f", bbox[:min_x]) %> to <%= sprintf("%.3f", bbox[:max_x]) %><br>
                      Y: <%= sprintf("%.3f", bbox[:min_y]) %> to <%= sprintf("%.3f", bbox[:max_y]) %>
                    <% else %>
                      Not available (requires calibration)
                    <% end %>
                  </td>
                </tr>
              </table>
            </div>
          </div>
          
          <% if @image.description.present? %>
            <div class="mt-3">
              <h5>Description</h5>
              <p><%= @image.description %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Well Information</h5>
        </div>
        <div class="card-body">
          <p><strong>Well:</strong> <%= @well.well_label %></p>
          <p><strong>Plate:</strong> <%= @well.plate.barcode %></p>
          <p><strong>Total Images:</strong> <%= @well.images.count %></p>
          <%= link_to 'Back to Plate Grid', @well.plate, class: 'btn btn-outline-primary btn-sm' %>
        </div>
      </div>
    </div>
  </div>
</div>




