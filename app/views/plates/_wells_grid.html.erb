<div class="container" 
     data-controller="well-layers"
     data-well-layers-config-value='<%= available_layers(@plate).to_json %>'
     data-well-layers-active-layers-value="[]"
     data-plate-barcode="<%= @plate.barcode %>">
  <div class="d-flex gap-3">
    <!-- Layer Control Sidebar -->
    <div class="layer-control-sidebar bg-light border rounded p-3" style="min-width: 250px; max-width: 300px;">
      <h6 class="fw-bold mb-3">
        <i class="bi bi-layers"></i> Well Layers
      </h6>
      
      <div class="layer-options">
        <% available_layers(@plate).each_with_index do |(layer_key, config), index| %>
          <div class="form-check mb-2">
            <input 
              class="form-check-input layer-toggle" 
              type="checkbox" 
              id="layer_<%= layer_key %>"
              value="<%= layer_key %>"
              data-layer="<%= layer_key %>"
              data-color="<%= config[:color] %>"
              data-well-layers-target="layerToggle"
              data-action="change->well-layers#layerToggleChanged"
              <%= 'checked' if index == 0 %>>
            <label class="form-check-label d-flex align-items-center" for="layer_<%= layer_key %>">
              <i class="<%= config[:icon] %> me-2" style="color: <%= config[:color] %>;"></i>
              <div class="fw-medium"><%= config[:name] %></div>
            </label>
          </div>
        <% end %>
      </div>
      
      <!-- Layer Stats -->
      <div class="mt-3 pt-3 border-top">
        <h6 class="fw-bold mb-2">Layer Statistics</h6>
        <div data-well-layers-target="statsContainer" class="small text-muted">
          <div>Loading...</div>
        </div>
      </div>

      <!-- Color Scale Legend -->
      <div class="mt-3 pt-3 border-top" data-well-layers-target="colorScaleContainer" style="display: none;">
        <div class="color-scale-legend">
          <div class="d-flex align-items-center mb-2">
            <div class="color-scale-bar" data-well-layers-target="colorScaleBar" style="width: 100%; height: 20px; border-radius: 4px; border: 1px solid #ddd;"></div>
          </div>
          <div class="d-flex justify-between small text-muted">
            <span data-well-layers-target="colorScaleMin" style="width: 50%; text-align: left;">0</span>
            <span data-well-layers-target="colorScaleMax" style="width: 50%; text-align: right;">100</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-grow-1">
      <div class="mb-2 d-flex justify-content-between align-items-center">
  <div class="form-check form-switch d-inline-block">
    <input class="form-check-input" type="checkbox" id="selectModeSwitch">
    <label class="form-check-label" for="selectModeSwitch">
      Multi select 
      <small class="text-muted" title="Keyboard shortcut: press 's' to toggle">(s)</small>
    </label>
  </div>
  <div>
    <button id="editMultipleWellsBtn" class="btn btn-outline-primary btn-sm d-none me-2" disabled 
            title="Edit selected wells (keyboard shortcut: e)">
      Edit multiple wells
    </button>
    <button id="clearSelectionBtn" class="btn btn-outline-secondary btn-sm d-none" 
            title="Clear all selections (keyboard shortcut: c)"
            onclick="if(window.wellSelector) { window.wellSelector.selectedWells.clear(); window.wellSelector.updateEditButton(); document.querySelectorAll('.well-select-btn.border-info').forEach(b => b.classList.remove('border-info', 'shadow')); }">
      Clear All
    </button>
  </div>
</div>
<div class="d-flex justify-content-center" style="background: #f8f9fa;">
  <div class="border rounded p-2 shadow-sm" id="well-grid-container">
    <div class="d-grid adaptive-well-grid" style="grid-template-columns: 40px repeat(<%= @columns %>, minmax(65px, 1fr)); gap: 8px; max-width: calc(100vw - 40px);">
      <% wells_in_a1 = @wells_by_position[[1, 1]] || [] %>
      <% subwell_selector_cols = subwell_grid_columns(wells_in_a1.length) %>
      <div class="d-grid" style="grid-template-columns: repeat(<%= subwell_selector_cols %>, 1fr); gap: 2px;">
      <!-- Subwell header buttons (copied from well A1) -->
      <% wells_in_a1.sort_by(&:subwell).each do |well| %>
        <button type="button" class="btn btn-outline-secondary btn-sm subwell-header-btn p-1"
          data-subwell="<%= well.subwell %>" disabled>
          <%= well.subwell %>
        </button>
      <% end %>
      </div>
      

      <!-- Column header buttons -->
      <% (1..@columns).each do |col| %>
        <button type="button" class="btn btn-outline-secondary btn-sm col-header-btn" data-col="<%= col %>" disabled>
          <%= col %>
        </button>
      <% end %>
    <% (1..@rows).each do |row| %>
            <!-- Row header button -->
        <button type="button" class="btn btn-outline-secondary btn-sm row-header-btn" data-row="<%= row %>" disabled>
          <%= ('A'.ord + row - 1).chr %>
        </button>
      <% (1..@columns).each do |col| %>
        <% wells_in_position = @wells_by_position[[row, col]] || [] %>
        <div class="well-position border rounded p-1" style="background: white; min-height: 20px;">
          <% if wells_in_position.any? %>
            <div class="text-center mb-1" style="font-size: 10px; font-weight: bold;">
              <%= wells_in_position.first.well_label  if wells_in_position.length > 1 %>
            </div>
            <% grid_cols = subwell_grid_columns(wells_in_position.length) %>
            <div class="d-grid" style="grid-template-columns: repeat(<%= grid_cols %>, 1fr); gap: 2px;">
              <% wells_in_position.sort_by(&:subwell).each do |well| %>
              <button type="button" class="btn btn-sm p-1 well-select-btn well-layer-btn"
                style="background-color: #f8f9fa; color: #6c757d; height: 20px; font-size: 9px;"
                data-well-id="<%= well.id %>"
                data-well-label="<%= well.well_label_with_subwell %>"
                data-col="<%= well.well_column %>"
                data-row="<%= well.well_row %>"
                data-subwell="<%= well.subwell %>"
                data-layer-data="<%= well_layer_data(well, @plate_custom_attributes, @well_scores_index).to_json %>"
                data-well-layers-target="wellButton"
                title="<%= well_tooltip_text(well) %>"
                <%= raw 'data-bs-toggle="modal" data-bs-target="#wellImagesModal"' %>>
                <% if wells_in_position.length > 1 %>
                <%= well.subwell %>
                <% else %>
                <%= wells_in_position.first.well_label %>
                <% end %>
              </button>
              <% end %>
            </div>
          <% else %>
            <div class="text-center text-muted" style="padding-top: 18px; font-size: 10px;">
              Empty
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
    </div> <!-- Close flex-grow-1 -->
  </div>   <!-- Close d-flex gap-3 -->
</div>     <!-- Close container -->

<!-- Layer System Styles -->
<style>
  .layer-control-sidebar {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }
  
  .layer-toggle:checked + .form-check-label {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-radius: 0.375rem;
    padding: 0.25rem;
    margin: -0.25rem;
  }
  
  .well-layer-btn {
    transition: all 0.2s ease;
    border: 1px solid rgba(0,0,0,0.1) !important;
  }
  
  .well-layer-btn:hover {
    transform: scale(1.1);
    z-index: 10;
    position: relative;
  }
  
  .well-value-input {
    font-weight: bold !important;
    font-size: 9px !important;
    color: inherit !important;
  }
  
  .well-value-input:focus {
    outline: 2px solid #0d6efd !important;
    outline-offset: -2px;
    background: rgba(255, 255, 255, 0.9) !important;
    color: #000 !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    z-index: 1050;
    position: relative;
  }
  
  .color-scale-bar {
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .color-scale-legend {
    font-size: 0.875rem;
  }
  
  @media (max-width: 768px) {
    .layer-control-sidebar {
      min-width: 200px;
      max-width: 220px;
    }
  }
</style>

<!-- Well Layers now handled by Stimulus controller -->
