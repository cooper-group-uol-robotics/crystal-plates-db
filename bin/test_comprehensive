#!/bin/bash

# Comprehensive Rails Test Runner Script
# This script provides options to run different categories of tests

echo "==============================================================================="
echo "Crystal Plates Database - Comprehensive Test Runner"
echo "==============================================================================="

# Change to the project directory
cd "$(dirname "$0")"

# Set test environment
export RAILS_ENV=test

# Function to run a specific test category
run_test_category() {
    local category=$1
    local description=$2
    
    echo ""
    echo "Running $description..."
    echo "-------------------------------------------------------------------------------"
    
    case $category in
        "models")
            bundle exec rails test test/models/
            ;;
        "controllers")
            bundle exec rails test test/controllers/
            ;;
        "integration")
            bundle exec rails test test/integration/
            ;;
        "system")
            bundle exec rails test:system
            ;;
        "all")
            bundle exec rails test
            ;;
        *)
            echo "Unknown test category: $category"
            exit 1
            ;;
    esac
}

# Function to show usage
show_usage() {
    echo "Usage: $0 [category]"
    echo ""
    echo "Categories:"
    echo "  models      - Run model tests only"
    echo "  controllers - Run controller tests only"
    echo "  integration - Run integration tests only"
    echo "  system      - Run system tests only"
    echo "  all         - Run all tests (default)"
    echo ""
    echo "Examples:"
    echo "  $0              # Run all tests"
    echo "  $0 models       # Run only model tests"
    echo "  $0 controllers  # Run only controller tests"
}

# Parse command line arguments
if [ $# -eq 0 ]; then
    # No arguments, run all tests
    TEST_CATEGORY="all"
elif [ $# -eq 1 ]; then
    case $1 in
        "--help"|"-h")
            show_usage
            exit 0
            ;;
        "models"|"controllers"|"integration"|"system"|"all")
            TEST_CATEGORY=$1
            ;;
        *)
            echo "Error: Unknown option '$1'"
            show_usage
            exit 1
            ;;
    esac
else
    echo "Error: Too many arguments"
    show_usage
    exit 1
fi

echo "Setting up test database..."
bundle exec rails db:test:prepare

# Run the requested test category
case $TEST_CATEGORY in
    "models")
        run_test_category "models" "Model Tests"
        ;;
    "controllers")
        run_test_category "controllers" "Controller Tests"
        ;;
    "integration")
        run_test_category "integration" "Integration Tests"
        ;;
    "system")
        run_test_category "system" "System Tests"
        ;;
    "all")
        run_test_category "all" "All Tests"
        ;;
esac

echo ""
echo "==============================================================================="
echo "Test run completed!"
echo "==============================================================================="
